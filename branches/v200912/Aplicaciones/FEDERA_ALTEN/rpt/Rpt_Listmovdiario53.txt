CREATE OR REPLACE PROCEDURE Rpt_Listmovdiario53(FECHAINI IN DATE,FECHAFIN IN DATE, CURSOROUT OUT Rpt.T_CURSOR)

IS

FECHAINI_1 DATE:=NVL(FECHAINI,'01/01/1900');
FECHAFIN_1 DATE:=NVL(FECHAFIN,'31/12/3000');

BEGIN

OPEN CURSOROUT FOR


	SELECT
	S.F_SALIDA  AS FECHA,
	P.CD_PUBLICACION AS CODIGO,
	CAST(S.NUM_EJEMPLARES AS VARCHAR2(100))  AS CANTIDAD,
	'0' AS  MOVIMIENTO,
	S.CD_OFICINA AS OFICINA,
	CAST(I.CD_CODIFICACION AS VARCHAR2(20)) || ' - ' || I.NOMBRE AS DS_OFICINA,
	--P.RESUMEN  AS OBSERVACIONES,
	S.OBSERVACIONES AS OBSERVACIONES,
	P.DS_PUBLICACION AS TITULO,
	(SELECT SUM(NUMEJEMPLARES)
	   FROM DAT_ENTRADAS A
	   WHERE A.CD_PUBLICACION=P.CD_PUBLICACION
	     AND A.F_ENTRADA IN (SELECT MIN(B.F_ENTRADA)
		                       FROM DAT_ENTRADAS B
							   WHERE B.CD_PUBLICACION=P.CD_PUBLICACION)) AS INI,
	TO_CHAR(S.F_SALIDA,'dd/mm/yyyy') DIAS,
	TO_CHAR(S.F_SALIDA,'dd') DIA,
	TO_CHAR(S.F_SALIDA,'mm') MES,
	TO_CHAR(S.F_SALIDA,'yyyy') EJERCICIO

	FROM  DAT_SALIDAS S, DAT_PUBLICACIONES P,DAT_INTERVINIENTES I

	WHERE P.CD_PUBLICACION=S.CD_PUBLICACION(+)
	  AND S.CD_OFICINA=I.CD_INTERVINIENTE
	  AND P.CD_TIPOPUBLICACION=1
	  AND S.CD_ESTADO='E' --Sólo salidas efectuadas.
	  AND S.F_SALIDA BETWEEN FECHAINI_1 AND FECHAFIN_1

	UNION ALL

	SELECT
	S.F_SALIDA  AS FECHA,
	P.CD_PUBLICACION AS CODIGO,
	CAST(S.NUM_EJEMPLARES AS VARCHAR2(100))  AS CANTIDAD,
	'0' AS  MOVIMIENTO,
	S.CD_OFICINA AS OFICINA,
	'' AS DS_OFICINA,
	--P.RESUMEN  AS OBSERVACIONES,
	S.OBSERVACIONES AS OBSERVACIONES,
	P.DS_PUBLICACION AS TITULO,
	(SELECT SUM(NUMEJEMPLARES)
	   FROM DAT_ENTRADAS A
	   WHERE A.CD_PUBLICACION=P.CD_PUBLICACION
	     AND A.F_ENTRADA IN (SELECT MIN(B.F_ENTRADA)
		                       FROM DAT_ENTRADAS B
							   WHERE B.CD_PUBLICACION=P.CD_PUBLICACION)) AS INI,
	TO_CHAR(S.F_SALIDA,'dd/mm/yyyy') DIAS,
	TO_CHAR(S.F_SALIDA,'dd') DIA,
	TO_CHAR(S.F_SALIDA,'mm') MES,
	TO_CHAR(S.F_SALIDA,'yyyy') EJERCICIO

	FROM  DAT_SALIDAS S, DAT_PUBLICACIONES P, AUX_DESTINOS D

	WHERE P.CD_PUBLICACION=S.CD_PUBLICACION(+)
	  AND S.OTRODESTINO=D.CD_DESTINO
	  AND P.CD_TIPOPUBLICACION=1
	  AND S.CD_ESTADO='E' --Sólo salidas efectuadas.
	  AND S.F_SALIDA BETWEEN FECHAINI_1 AND FECHAFIN_1

	/*
	SELECT
	E.F_ENTRADA,
	P.CD_PUBLICACION AS CODIGO,
	CAST(E.NUMEJEMPLARES AS VARCHAR2(100)) AS CANTIDAD,
	'1' AS MOVIMIENTO,
	E.CD_OFICINA AS OFICINA,
	I.NOMBRE AS DS_OFICINA,
	P.RESUMEN AS OBSERVACIONES,
	P.DS_PUBLICACION TITULO,
	(SELECT SUM(NUMEJEMPLARES)
	   FROM DAT_ENTRADAS A
	   WHERE A.CD_PUBLICACION=P.CD_PUBLICACION
	     AND A.F_ENTRADA IN (SELECT MIN(B.F_ENTRADA)
		                       FROM DAT_ENTRADAS B
							   WHERE B.CD_PUBLICACION=P.CD_PUBLICACION)) AS INI,
	TO_CHAR(E.F_ENTRADA,'dd/mm/yyyy') DIAS,
	TO_CHAR(E.F_ENTRADA,'dd') DIA,
	TO_CHAR(E.F_ENTRADA,'mm') MES,
	TO_CHAR(E.F_ENTRADA,'yyyy') EJERCICIO

	FROM DAT_ENTRADAS E,DAT_PUBLICACIONES P, DAT_INTERVINIENTES I

	WHERE P.CD_PUBLICACION=E.CD_PUBLICACION(+)
	  AND E.CD_OFICINA=I.CD_INTERVINIENTE(+)
	  AND P.CD_TIPOPUBLICACION=1
	  AND E.F_ENTRADA BETWEEN FECHAINI_1 AND FECHAFIN_1*/

	ORDER BY 1, 2;


END Rpt_Listmovdiario53;
/
